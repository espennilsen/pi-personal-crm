<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CRM</title>
<style>
  :root {
    --bg: #0a0a0f; --bg2: #12121a; --bg3: #1a1a25;
    --fg: #e0e0e8; --fg2: #888898; --fg3: #555568;
    --accent: #7c6ff0; --accent2: #9d8cf0;
    --green: #4ade80; --red: #f87171; --yellow: #fbbf24; --blue: #60a5fa;
    --border: #2a2a3a; --radius: 8px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--fg); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif; font-size: 14px; line-height: 1.5; }

  /* â”€â”€ Navbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  nav { background: var(--bg2); border-bottom: 1px solid var(--border); padding: 0 20px; display: flex; align-items: center; gap: 0; position: sticky; top: 0; z-index: 900; }
  nav .nav-brand { font-size: 16px; font-weight: 700; color: var(--accent); padding: 12px 16px 12px 0; margin-right: 8px; border-right: 1px solid var(--border); }
  nav a { color: var(--fg2); text-decoration: none; font-size: 13px; font-weight: 500; padding: 12px 16px; transition: all 0.15s; border-bottom: 2px solid transparent; }
  nav a:hover { color: var(--fg); background: rgba(255,255,255,0.03); }
  nav a.active { color: var(--accent2); border-bottom-color: var(--accent); }
  nav .nav-spacer { flex: 1; }

  /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
  .split-view { display: grid; grid-template-columns: 400px 1fr; gap: 20px; }
  @media (max-width: 1024px) { .split-view { grid-template-columns: 1fr; } }

  /* â”€â”€ Toolbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .toolbar { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }
  .toolbar h1 { font-size: 18px; font-weight: 700; }
  .search-box { background: var(--bg3); border: 1px solid var(--border); color: var(--fg); padding: 6px 12px; border-radius: var(--radius); font-size: 13px; width: 300px; }
  .search-box:focus { outline: none; border-color: var(--accent); }
  .btn { background: var(--bg3); border: 1px solid var(--border); color: var(--fg); padding: 6px 14px; border-radius: var(--radius); cursor: pointer; font-size: 13px; transition: all 0.15s; }
  .btn:hover { background: var(--accent); color: #fff; border-color: var(--accent); }
  .btn-primary { background: var(--accent); color: #fff; border-color: var(--accent); }
  .btn-primary:hover { background: var(--accent2); border-color: var(--accent2); }
  .btn-sm { padding: 4px 10px; font-size: 12px; }
  .btn-danger { color: var(--red); }
  .btn-danger:hover { background: var(--red); color: #fff; border-color: var(--red); }

  /* â”€â”€ Contact List â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .contact-list { background: var(--bg2); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; max-height: calc(100vh - 180px); overflow-y: auto; }
  .contact-item { padding: 14px 16px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.15s; }
  .contact-item:hover { background: var(--bg3); }
  .contact-item.active { background: rgba(124,111,240,0.15); border-left: 3px solid var(--accent); }
  .contact-item:last-child { border-bottom: none; }
  .contact-name { font-weight: 600; font-size: 14px; margin-bottom: 2px; }
  .contact-meta { font-size: 12px; color: var(--fg2); display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  .contact-company { color: var(--fg3); }
  .contact-tags { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 4px; }
  .tag { background: var(--bg3); border: 1px solid var(--border); padding: 2px 6px; border-radius: 4px; font-size: 10px; color: var(--fg2); }

  /* â”€â”€ Contact Detail â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .detail-panel { background: var(--bg2); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; max-height: calc(100vh - 180px); overflow-y: auto; }
  .detail-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 20px; }
  .detail-actions { display: flex; gap: 8px; }
  .contact-avatar { width: 64px; height: 64px; border-radius: 50%; background: var(--bg3); border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 700; color: var(--accent); margin-bottom: 12px; }
  .detail-name { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
  .detail-company { font-size: 14px; color: var(--fg2); margin-bottom: 12px; }
  .detail-field { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 13px; }
  .detail-field-icon { color: var(--fg3); width: 20px; text-align: center; }
  .section { margin-top: 24px; }
  .section-title { font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--fg2); text-transform: uppercase; letter-spacing: 0.5px; }
  .empty-state { text-align: center; padding: 40px 20px; color: var(--fg3); }

  /* â”€â”€ Timeline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .timeline { border-left: 2px solid var(--border); padding-left: 0; }
  .timeline-item { position: relative; padding-left: 32px; padding-bottom: 20px; }
  .timeline-item:last-child { padding-bottom: 0; }
  .timeline-dot { position: absolute; left: -9px; top: 0; width: 16px; height: 16px; border-radius: 50%; background: var(--bg3); border: 3px solid var(--border); }
  .timeline-dot.call { border-color: var(--blue); }
  .timeline-dot.meeting { border-color: var(--green); }
  .timeline-dot.email { border-color: var(--yellow); }
  .timeline-dot.note { border-color: var(--accent); }
  .timeline-dot.gift { border-color: var(--red); }
  .timeline-dot.message { border-color: var(--accent2); }
  .timeline-date { font-size: 11px; color: var(--fg3); margin-bottom: 4px; }
  .timeline-content { background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; }
  .timeline-type { display: inline-block; background: var(--bg); padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; margin-bottom: 6px; text-transform: uppercase; }
  .timeline-type.call { color: var(--blue); }
  .timeline-type.meeting { color: var(--green); }
  .timeline-type.email { color: var(--yellow); }
  .timeline-type.note { color: var(--accent); }
  .timeline-type.gift { color: var(--red); }
  .timeline-type.message { color: var(--accent2); }
  .timeline-summary { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
  .timeline-notes { font-size: 12px; color: var(--fg2); }

  /* â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
  .modal.show { display: flex; }
  .modal-content { background: var(--bg2); border: 1px solid var(--border); border-radius: var(--radius); width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
  .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
  .modal-title { font-size: 18px; font-weight: 700; }
  .modal-close { background: none; border: none; color: var(--fg2); font-size: 24px; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: var(--radius); }
  .modal-close:hover { background: var(--bg3); color: var(--fg); }
  .modal-body { padding: 20px; }
  .form-group { margin-bottom: 16px; }
  .form-label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--fg2); }
  .form-input, .form-textarea, .form-select { background: var(--bg3); border: 1px solid var(--border); color: var(--fg); padding: 8px 12px; border-radius: var(--radius); font-size: 13px; width: 100%; }
  .form-input:focus, .form-textarea:focus, .form-select:focus { outline: none; border-color: var(--accent); }
  .form-textarea { resize: vertical; min-height: 80px; }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  @media (max-width: 600px) { .form-row { grid-template-columns: 1fr; } }
  .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; }

  /* â”€â”€ Relationships & Reminders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .rel-list, .rem-list { display: flex; flex-direction: column; gap: 8px; }
  .rel-item, .rem-item { background: var(--bg3); border: 1px solid var(--border); padding: 10px 12px; border-radius: var(--radius); font-size: 13px; display: flex; justify-content: space-between; align-items: center; }
  .rel-type, .rem-type { font-size: 11px; color: var(--fg3); text-transform: uppercase; }
  .rel-name { font-weight: 600; }
  .rel-item > div[onclick]:hover .rel-name { color: var(--accent2); }
  .delete-icon { background: none; border: none; color: var(--fg3); cursor: pointer; font-size: 14px; padding: 2px 6px; border-radius: 4px; opacity: 0.5; transition: all 0.15s; }
  .delete-icon:hover { opacity: 1; color: var(--red); background: rgba(248,113,113,0.1); }
</style>
</head>
<body>

<nav id="crmNav">
  <span class="nav-brand">CRM</span>
  <a href="/crm" class="active">Contacts</a>
  <div class="nav-spacer"></div>
</nav>

<div class="container">
  <div class="toolbar">
    <h1>ğŸ“‡ CRM</h1>
    <input type="text" id="search" class="search-box" placeholder="Search contacts...">
    <div style="flex: 1"></div>
    <button class="btn" onclick="exportCsv()">â¬‡ Export</button>
    <button class="btn" onclick="document.getElementById('csvFileInput').click()">â¬† Import</button>
    <input type="file" id="csvFileInput" accept=".csv" style="display:none" onchange="importCsv(event)">
    <button class="btn btn-primary" onclick="showAddContactModal()">+ New Contact</button>
  </div>

  <div class="split-view">
    <!-- Contact List -->
    <div>
      <div class="contact-list" id="contactList">
        <div class="empty-state">
          <p>No contacts yet</p>
          <p style="margin-top: 8px; font-size: 12px;">Click "+ New Contact" to get started</p>
        </div>
      </div>
    </div>

    <!-- Contact Detail -->
    <div>
      <div class="detail-panel" id="detailPanel">
        <div class="empty-state">
          <p>Select a contact to view details</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add/Edit Contact Modal -->
<div class="modal" id="contactModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="contactModalTitle">New Contact</h2>
      <button class="modal-close" onclick="closeModal('contactModal')">&times;</button>
    </div>
    <div class="modal-body">
      <form id="contactForm" onsubmit="saveContact(event)">
        <input type="hidden" id="contactId">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">First Name *</label>
            <input type="text" id="firstName" class="form-input" required>
          </div>
          <div class="form-group">
            <label class="form-label">Last Name</label>
            <input type="text" id="lastName" class="form-input">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" id="email" class="form-input">
          </div>
          <div class="form-group">
            <label class="form-label">Phone</label>
            <input type="tel" id="phone" class="form-input">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Company</label>
          <input type="text" id="companyName" class="form-input" list="companies">
          <datalist id="companies"></datalist>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Birthday</label>
            <input type="date" id="birthday" class="form-input">
          </div>
          <div class="form-group">
            <label class="form-label">Anniversary</label>
            <input type="date" id="anniversary" class="form-input">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Tags (comma-separated)</label>
          <input type="text" id="tags" class="form-input" placeholder="client, vip, developer">
        </div>
        <div class="form-group">
          <label class="form-label">Notes</label>
          <textarea id="notes" class="form-textarea"></textarea>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('contactModal')">Cancel</button>
      <button class="btn btn-primary" onclick="document.getElementById('contactForm').dispatchEvent(new Event('submit'))">Save</button>
    </div>
  </div>
</div>

<!-- Add Interaction Modal -->
<div class="modal" id="interactionModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Log Interaction</h2>
      <button class="modal-close" onclick="closeModal('interactionModal')">&times;</button>
    </div>
    <div class="modal-body">
      <form id="interactionForm" onsubmit="saveInteraction(event)">
        <div class="form-group">
          <label class="form-label">Type *</label>
          <select id="interactionType" class="form-select" required>
            <option value="call">ğŸ“ Call</option>
            <option value="meeting">ğŸ¤ Meeting</option>
            <option value="email">ğŸ“§ Email</option>
            <option value="note">ğŸ“ Note</option>
            <option value="gift">ğŸ Gift</option>
            <option value="message">ğŸ’¬ Message</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Summary *</label>
          <input type="text" id="interactionSummary" class="form-input" required placeholder="Brief description">
        </div>
        <div class="form-group">
          <label class="form-label">Notes</label>
          <textarea id="interactionNotes" class="form-textarea"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Date & Time</label>
          <input type="datetime-local" id="happenedAt" class="form-input">
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('interactionModal')">Cancel</button>
      <button class="btn btn-primary" onclick="document.getElementById('interactionForm').dispatchEvent(new Event('submit'))">Save</button>
    </div>
  </div>
</div>

<!-- Add Reminder Modal -->
<div class="modal" id="reminderModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Add Reminder</h2>
      <button class="modal-close" onclick="closeModal('reminderModal')">&times;</button>
    </div>
    <div class="modal-body">
      <form id="reminderForm" onsubmit="saveReminder(event)">
        <div class="form-group">
          <label class="form-label">Type *</label>
          <select id="reminderType" class="form-select" required>
            <option value="birthday">ğŸ‚ Birthday</option>
            <option value="anniversary">ğŸ’ Anniversary</option>
            <option value="custom">ğŸ“Œ Custom</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Date *</label>
          <input type="date" id="reminderDate" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">Message</label>
          <input type="text" id="reminderMessage" class="form-input" placeholder="Optional reminder message">
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('reminderModal')">Cancel</button>
      <button class="btn btn-primary" onclick="document.getElementById('reminderForm').dispatchEvent(new Event('submit'))">Save</button>
    </div>
  </div>
</div>

<!-- Add Relationship Modal -->
<div class="modal" id="relationshipModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Add Relationship</h2>
      <button class="modal-close" onclick="closeModal('relationshipModal')">&times;</button>
    </div>
    <div class="modal-body">
      <form id="relationshipForm" onsubmit="saveRelationship(event)">
        <div class="form-group">
          <label class="form-label">Related Contact *</label>
          <select id="relatedContactId" class="form-select" required>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Relationship Type *</label>
          <input type="text" id="relationshipType" class="form-input" required placeholder="spouse, colleague, friend, parent, child..." list="relTypes">
          <datalist id="relTypes">
            <option value="spouse">
            <option value="partner">
            <option value="parent">
            <option value="child">
            <option value="sibling">
            <option value="colleague">
            <option value="friend">
            <option value="manager">
            <option value="mentor">
          </datalist>
        </div>
        <div class="form-group">
          <label class="form-label">Notes</label>
          <input type="text" id="relationshipNotes" class="form-input" placeholder="Optional notes">
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('relationshipModal')">Cancel</button>
      <button class="btn btn-primary" onclick="document.getElementById('relationshipForm').dispatchEvent(new Event('submit'))">Save</button>
    </div>
  </div>
</div>

<!-- Group Management Modal -->
<div class="modal" id="groupModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Manage Groups</h2>
      <button class="modal-close" onclick="closeModal('groupModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div id="groupList" style="margin-bottom: 16px;"></div>
      <div style="display: flex; gap: 8px;">
        <input type="text" id="newGroupName" class="form-input" placeholder="New group name..." style="flex: 1;">
        <button class="btn btn-primary" onclick="addToNewGroup()">+ Add</button>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('groupModal')">Done</button>
    </div>
  </div>
</div>

<script>
  let currentContactId = null;
  let allContacts = [];

  // â”€â”€ XSS Escaping â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function esc(str) {
    if (str == null) return '';
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  async function init() {
    await loadContacts();
    await loadCompanies();
    
    // Search handler
    document.getElementById('search').addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      filterContacts(query);
    });
  }

  // â”€â”€ Contacts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  async function loadContacts() {
    try {
      const res = await fetch('/api/crm/contacts?limit=1000');
      allContacts = await res.json();
      renderContacts(allContacts);
      if (allContacts.length > 0 && !currentContactId) {
        selectContact(allContacts[0].id);
      }
    } catch (err) {
      console.error('Failed to load contacts:', err);
    }
  }

  function filterContacts(query) {
    if (!query) {
      renderContacts(allContacts);
      return;
    }
    const filtered = allContacts.filter(c =>
      c.first_name.toLowerCase().includes(query) ||
      (c.last_name && c.last_name.toLowerCase().includes(query)) ||
      (c.email && c.email.toLowerCase().includes(query)) ||
      (c.company_name && c.company_name.toLowerCase().includes(query)) ||
      (c.tags && c.tags.toLowerCase().includes(query))
    );
    renderContacts(filtered);
  }

  function renderContacts(contacts) {
    const list = document.getElementById('contactList');
    if (contacts.length === 0) {
      list.innerHTML = '<div class="empty-state"><p>No contacts found</p></div>';
      return;
    }
    list.innerHTML = contacts.map(c => `
      <div class="contact-item ${c.id === currentContactId ? 'active' : ''}" onclick="selectContact(${c.id})">
        <div class="contact-name">${esc(c.first_name)} ${esc(c.last_name)}</div>
        <div class="contact-meta">
          ${c.email ? `<span>ğŸ“§ ${esc(c.email)}</span>` : ''}
          ${c.company_name ? `<span class="contact-company">@ ${esc(c.company_name)}</span>` : ''}
        </div>
        ${c.tags ? `<div class="contact-tags">${c.tags.split(',').map(t => `<span class="tag">${esc(t.trim())}</span>`).join('')}</div>` : ''}
      </div>
    `).join('');
  }

  async function selectContact(id) {
    currentContactId = id;
    renderContacts(allContacts);
    await loadContactDetail(id);
  }

  async function loadContactDetail(id) {
    try {
      const res = await fetch(`/api/crm/contacts/${id}`);
      const data = await res.json();
      renderContactDetail(data);
    } catch (err) {
      console.error('Failed to load contact detail:', err);
    }
  }

  function renderContactDetail(data) {
    const { contact, interactions, reminders, relationships, groups } = data;
    
    const initials = `${contact.first_name.charAt(0)}${(contact.last_name || '').charAt(0)}`.toUpperCase();
    
    const panel = document.getElementById('detailPanel');
    panel.innerHTML = `
      <div class="detail-header">
        <div style="flex: 1;">
          <div class="contact-avatar">${esc(initials)}</div>
          <div class="detail-name">${esc(contact.first_name)} ${esc(contact.last_name)}</div>
          ${contact.company_name ? `<div class="detail-company">@ ${esc(contact.company_name)}</div>` : ''}
          ${contact.tags ? `<div class="contact-tags">${contact.tags.split(',').map(t => `<span class="tag">${esc(t.trim())}</span>`).join('')}</div>` : ''}
        </div>
        <div class="detail-actions">
          <button class="btn btn-sm" onclick="showEditContactModal(${contact.id})">âœï¸ Edit</button>
          <button class="btn btn-sm" onclick="showInteractionModal()">+ Interaction</button>
          <button class="btn btn-sm" onclick="showReminderModal()">+ Reminder</button>
          <button class="btn btn-sm" onclick="showRelationshipModal()">+ Relationship</button>
          <button class="btn btn-sm" onclick="showGroupModal()">ğŸ“‚ Groups</button>
          <button class="btn btn-sm btn-danger" onclick="deleteContact(${contact.id})">ğŸ—‘ï¸</button>
        </div>
      </div>

      ${contact.email || contact.phone || contact.birthday || contact.anniversary ? `
      <div class="section">
        ${contact.email ? `<div class="detail-field"><span class="detail-field-icon">ğŸ“§</span> ${esc(contact.email)}</div>` : ''}
        ${contact.phone ? `<div class="detail-field"><span class="detail-field-icon">ğŸ“</span> ${esc(contact.phone)}</div>` : ''}
        ${contact.birthday ? `<div class="detail-field"><span class="detail-field-icon">ğŸ‚</span> Birthday: ${esc(contact.birthday)}</div>` : ''}
        ${contact.anniversary ? `<div class="detail-field"><span class="detail-field-icon">ğŸ’</span> Anniversary: ${esc(contact.anniversary)}</div>` : ''}
      </div>
      ` : ''}

      ${contact.notes ? `
      <div class="section">
        <div class="section-title">Notes</div>
        <div style="font-size: 13px; color: var(--fg2);">${esc(contact.notes).replace(/\n/g, '<br>')}</div>
      </div>
      ` : ''}

      ${reminders.length > 0 ? `
      <div class="section">
        <div class="section-title">Reminders</div>
        <div class="rem-list">
          ${reminders.map(r => `
            <div class="rem-item">
              <div>
                <div class="rem-type">${esc(r.reminder_type)}</div>
                <div>${esc(r.reminder_date)}${r.message ? ` â€” ${esc(r.message)}` : ''}</div>
              </div>
              <button class="delete-icon" onclick="deleteReminder(${r.id})" title="Delete reminder">âœ•</button>
            </div>
          `).join('')}
        </div>
      </div>
      ` : ''}

      ${relationships.length > 0 ? `
      <div class="section">
        <div class="section-title">Relationships</div>
        <div class="rel-list">
          ${relationships.map(r => `
            <div class="rel-item">
              <div onclick="selectContact(${r.related_contact_id})" style="cursor: pointer;">
                <div class="rel-type">${esc(r.relationship_type)}</div>
                <div class="rel-name">${esc(r.first_name)} ${esc(r.last_name)}</div>
              </div>
              <button class="delete-icon" onclick="deleteRelationship(${r.id})" title="Delete relationship">âœ•</button>
            </div>
          `).join('')}
        </div>
      </div>
      ` : ''}

      ${groups && groups.length > 0 ? `
      <div class="section">
        <div class="section-title">Groups</div>
        <div class="contact-tags" style="gap: 6px;">
          ${groups.map(g => `<span class="tag" style="font-size: 12px; padding: 4px 8px;">ğŸ“‚ ${esc(g.name)}</span>`).join('')}
        </div>
      </div>
      ` : ''}

      <div class="section">
        <div class="section-title">Timeline</div>
        ${interactions.length > 0 ? `
          <div class="timeline">
            ${interactions.map(i => `
              <div class="timeline-item">
                <div class="timeline-dot ${esc(i.interaction_type)}"></div>
                <div class="timeline-date">${new Date(i.happened_at).toLocaleString()}</div>
                <div class="timeline-content" style="position: relative;">
                  <button class="delete-icon" onclick="deleteInteraction(${i.id})" title="Delete interaction" style="position: absolute; top: 8px; right: 8px;">âœ•</button>
                  <div class="timeline-type ${esc(i.interaction_type)}">${esc(i.interaction_type)}</div>
                  <div class="timeline-summary">${esc(i.summary)}</div>
                  ${i.notes ? `<div class="timeline-notes">${esc(i.notes)}</div>` : ''}
                </div>
              </div>
            `).join('')}
          </div>
        ` : '<div class="empty-state" style="padding: 20px;"><p>No interactions yet</p></div>'}
      </div>
    `;
  }

  // â”€â”€ Companies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  async function loadCompanies() {
    try {
      const res = await fetch('/api/crm/companies');
      const companies = await res.json();
      const datalist = document.getElementById('companies');
      datalist.innerHTML = companies.map(c => `<option value="${esc(c.name)}">`).join('');
    } catch (err) {
      console.error('Failed to load companies:', err);
    }
  }

  // â”€â”€ Modal Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function showAddContactModal() {
    document.getElementById('contactModalTitle').textContent = 'New Contact';
    document.getElementById('contactForm').reset();
    document.getElementById('contactId').value = '';
    showModal('contactModal');
  }

  async function showEditContactModal(id) {
    const contact = allContacts.find(c => c.id === id);
    if (!contact) return;

    document.getElementById('contactModalTitle').textContent = 'Edit Contact';
    document.getElementById('contactId').value = contact.id;
    document.getElementById('firstName').value = contact.first_name;
    document.getElementById('lastName').value = contact.last_name || '';
    document.getElementById('email').value = contact.email || '';
    document.getElementById('phone').value = contact.phone || '';
    document.getElementById('companyName').value = contact.company_name || '';
    document.getElementById('birthday').value = contact.birthday || '';
    document.getElementById('anniversary').value = contact.anniversary || '';
    document.getElementById('tags').value = contact.tags || '';
    document.getElementById('notes').value = contact.notes || '';
    showModal('contactModal');
  }

  async function saveContact(e, force = false) {
    e.preventDefault();
    
    const id = document.getElementById('contactId').value;
    const data = {
      first_name: document.getElementById('firstName').value,
      last_name: document.getElementById('lastName').value || null,
      email: document.getElementById('email').value || null,
      phone: document.getElementById('phone').value || null,
      company_name: document.getElementById('companyName').value || null,
      birthday: document.getElementById('birthday').value || null,
      anniversary: document.getElementById('anniversary').value || null,
      tags: document.getElementById('tags').value || null,
      notes: document.getElementById('notes').value || null,
    };

    try {
      if (id) {
        // Update â€” no dupe check needed
        await fetch(`/api/crm/contacts/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
      } else {
        // New contact â€” check for duplicates first
        if (!force) {
          const dupeRes = await fetch('/api/crm/contacts/check-duplicates', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ first_name: data.first_name, last_name: data.last_name, email: data.email })
          });
          const { duplicates } = await dupeRes.json();
          if (duplicates && duplicates.length > 0) {
            const names = duplicates.map(d => `${d.first_name} ${d.last_name || ''} (${d.email || 'no email'}, ID: ${d.id})`).join('\n  ');
            if (!confirm(`âš ï¸ Possible duplicate(s) found:\n  ${names}\n\nCreate anyway?`)) {
              return;
            }
          }
        }

        const res = await fetch('/api/crm/contacts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const newContact = await res.json();
        currentContactId = newContact.id;
      }
      closeModal('contactModal');
      await loadContacts();
      if (currentContactId) {
        await selectContact(currentContactId);
      }
    } catch (err) {
      console.error('Failed to save contact:', err);
      alert('Failed to save contact');
    }
  }

  async function deleteContact(id) {
    if (!confirm('Delete this contact? This cannot be undone.')) return;
    
    try {
      await fetch(`/api/crm/contacts/${id}`, { method: 'DELETE' });
      currentContactId = null;
      await loadContacts();
      document.getElementById('detailPanel').innerHTML = '<div class="empty-state"><p>Contact deleted</p></div>';
    } catch (err) {
      console.error('Failed to delete contact:', err);
      alert('Failed to delete contact');
    }
  }

  function showInteractionModal() {
    if (!currentContactId) return;
    document.getElementById('interactionForm').reset();
    document.getElementById('happenedAt').value = new Date().toISOString().slice(0, 16);
    showModal('interactionModal');
  }

  async function saveInteraction(e) {
    e.preventDefault();
    
    const data = {
      contact_id: currentContactId,
      interaction_type: document.getElementById('interactionType').value,
      summary: document.getElementById('interactionSummary').value,
      notes: document.getElementById('interactionNotes').value || null,
      happened_at: document.getElementById('happenedAt').value ? new Date(document.getElementById('happenedAt').value).toISOString() : null,
    };

    try {
      await fetch('/api/crm/interactions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      closeModal('interactionModal');
      await loadContactDetail(currentContactId);
    } catch (err) {
      console.error('Failed to save interaction:', err);
      alert('Failed to save interaction');
    }
  }

  // â”€â”€ Reminder Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function showReminderModal() {
    if (!currentContactId) return;
    document.getElementById('reminderForm').reset();
    showModal('reminderModal');
  }

  async function saveReminder(e) {
    e.preventDefault();

    const data = {
      contact_id: currentContactId,
      reminder_type: document.getElementById('reminderType').value,
      reminder_date: document.getElementById('reminderDate').value,
      message: document.getElementById('reminderMessage').value || null,
    };

    try {
      await fetch('/api/crm/reminders', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      closeModal('reminderModal');
      await loadContactDetail(currentContactId);
    } catch (err) {
      console.error('Failed to save reminder:', err);
      alert('Failed to save reminder');
    }
  }

  // â”€â”€ Relationship Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function showRelationshipModal() {
    if (!currentContactId) return;
    document.getElementById('relationshipForm').reset();

    // Populate contact select (exclude current contact)
    const select = document.getElementById('relatedContactId');
    select.innerHTML = allContacts
      .filter(c => c.id !== currentContactId)
      .map(c => `<option value="${c.id}">${esc(c.first_name)} ${esc(c.last_name)}</option>`)
      .join('');

    if (select.options.length === 0) {
      select.innerHTML = '<option value="" disabled>No other contacts available</option>';
    }

    showModal('relationshipModal');
  }

  async function saveRelationship(e) {
    e.preventDefault();

    const relatedId = parseInt(document.getElementById('relatedContactId').value);
    if (!relatedId) return;

    const data = {
      contact_id: currentContactId,
      related_contact_id: relatedId,
      relationship_type: document.getElementById('relationshipType').value,
      notes: document.getElementById('relationshipNotes').value || null,
    };

    try {
      await fetch('/api/crm/relationships', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      closeModal('relationshipModal');
      await loadContactDetail(currentContactId);
    } catch (err) {
      console.error('Failed to save relationship:', err);
      alert('Failed to save relationship');
    }
  }

  // â”€â”€ Group Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  let allGroups = [];

  async function showGroupModal() {
    if (!currentContactId) return;

    // Load all groups and contact's current groups
    const [groupsRes, contactGroupsRes] = await Promise.all([
      fetch('/api/crm/groups'),
      fetch(`/api/crm/contacts/${currentContactId}`)
    ]);
    allGroups = await groupsRes.json();
    const detail = await contactGroupsRes.json();
    const contactGroupIds = new Set((detail.groups || []).map(g => g.id));

    renderGroupList(contactGroupIds);
    document.getElementById('newGroupName').value = '';
    showModal('groupModal');
  }

  function renderGroupList(contactGroupIds) {
    const list = document.getElementById('groupList');
    if (allGroups.length === 0) {
      list.innerHTML = '<div style="color: var(--fg3); font-size: 13px;">No groups yet. Create one below.</div>';
      return;
    }

    list.innerHTML = allGroups.map(g => {
      const isMember = contactGroupIds.has(g.id);
      return `
        <div class="rel-item" style="margin-bottom: 6px;">
          <div>
            <div style="font-weight: 600; font-size: 13px;">ğŸ“‚ ${esc(g.name)}</div>
            ${g.description ? `<div style="font-size: 11px; color: var(--fg3);">${esc(g.description)}</div>` : ''}
          </div>
          ${isMember
            ? `<button class="btn btn-sm btn-danger" onclick="toggleGroup(${g.id}, false)">Remove</button>`
            : `<button class="btn btn-sm" onclick="toggleGroup(${g.id}, true)">Add</button>`
          }
        </div>
      `;
    }).join('');
  }

  async function toggleGroup(groupId, add) {
    try {
      if (add) {
        await fetch(`/api/crm/groups/${groupId}/members`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contact_id: currentContactId })
        });
      } else {
        await fetch(`/api/crm/groups/${groupId}/members/${currentContactId}`, {
          method: 'DELETE'
        });
      }
      // Refresh the modal
      await showGroupModal();
      // Also refresh the detail panel behind the modal
      await loadContactDetail(currentContactId);
    } catch (err) {
      console.error('Failed to update group membership:', err);
    }
  }

  async function addToNewGroup() {
    const nameInput = document.getElementById('newGroupName');
    const name = nameInput.value.trim();
    if (!name) return;

    try {
      // Create group
      const res = await fetch('/api/crm/groups', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name })
      });
      const group = await res.json();

      // Add contact to it
      await fetch(`/api/crm/groups/${group.id}/members`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contact_id: currentContactId })
      });

      nameInput.value = '';
      await showGroupModal();
      await loadContactDetail(currentContactId);
    } catch (err) {
      console.error('Failed to create group:', err);
      alert('Failed to create group');
    }
  }

  // â”€â”€ Import/Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function exportCsv() {
    window.location.href = '/api/crm/contacts/export.csv';
  }

  async function importCsv(e) {
    const file = e.target.files[0];
    if (!file) return;

    const text = await file.text();
    e.target.value = ''; // reset so same file can be re-selected

    try {
      const res = await fetch('/api/crm/contacts/import', {
        method: 'POST',
        headers: { 'Content-Type': 'text/csv' },
        body: text
      });
      const result = await res.json();

      let msg = `Import complete:\nâœ… Created: ${result.created}\nâ­ Skipped: ${result.skipped}`;
      if (result.duplicates && result.duplicates.length > 0) {
        msg += `\n\nâš ï¸ Duplicates found (skipped):`;
        for (const d of result.duplicates) {
          msg += `\n  Row ${d.row}: "${d.incoming}" matches "${d.existing.first_name} ${d.existing.last_name || ''}" (ID: ${d.existing.id})`;
        }
      }
      if (result.errors && result.errors.length > 0) {
        msg += `\n\nâŒ Errors:\n  ${result.errors.join('\n  ')}`;
      }

      alert(msg);
      await loadContacts();
      await loadCompanies();
    } catch (err) {
      console.error('Failed to import CSV:', err);
      alert('Failed to import CSV');
    }
  }

  // â”€â”€ Delete Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  async function deleteInteraction(id) {
    if (!confirm('Delete this interaction?')) return;
    try {
      await fetch(`/api/crm/interactions/${id}`, { method: 'DELETE' });
      await loadContactDetail(currentContactId);
    } catch (err) {
      console.error('Failed to delete interaction:', err);
    }
  }

  async function deleteReminder(id) {
    if (!confirm('Delete this reminder?')) return;
    try {
      await fetch(`/api/crm/reminders/${id}`, { method: 'DELETE' });
      await loadContactDetail(currentContactId);
    } catch (err) {
      console.error('Failed to delete reminder:', err);
    }
  }

  async function deleteRelationship(id) {
    if (!confirm('Delete this relationship?')) return;
    try {
      await fetch(`/api/crm/relationships/${id}`, { method: 'DELETE' });
      await loadContactDetail(currentContactId);
    } catch (err) {
      console.error('Failed to delete relationship:', err);
    }
  }

  function showModal(id) {
    document.getElementById(id).classList.add('show');
  }

  function closeModal(id) {
    document.getElementById(id).classList.remove('show');
  }

  // Close modals on escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      document.querySelectorAll('.modal.show').forEach(m => m.classList.remove('show'));
    }
  });

  // Close modals on backdrop click
  document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.remove('show');
      }
    });
  });

  // Start app
  init();
</script>

</body>
</html>
